name: CI-CD Pipeline (6-Stage)

on:
  push:
    branches: [ main, master, fix/correct-ci-workflow ] # Triggers on push to these branches
  pull_request:
    branches: [ main, master ]

jobs:
  # --- 1. BUILD Job ---
  build:
    name: 1. Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Using Node 20 as specified
          cache: 'npm'
          cache-dependency-path: |
            **/package-lock.json
      - name: Install Backend Dependencies
        run: npm ci
        working-directory: ./
      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./insurance-frontend

  # --- 2. TEST Job ---
  test:
    name: 2. Test
    runs-on: ubuntu-latest
    needs: build # Runs after 'build' job
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            **/package-lock.json
      - name: Install Backend Dependencies
        run: npm ci
      - name: Run Backend Tests
        run: npm test
      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./insurance-frontend
      - name: Run Frontend Tests
        run: npm test
        working-directory: ./insurance-frontend

  # --- 3. COVERAGE Job ---
  coverage:
    name: 3. Coverage (>=75%)
    runs-on: ubuntu-latest
    needs: build # Runs after 'build'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            **/package-lock.json
      - name: Install Backend Dependencies
        run: npm ci
      - name: Run Backend Coverage
        run: npm test -- --coverage
      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./insurance-frontend
      - name: Run Frontend Coverage
        run: npm test -- --coverage
        working-directory: ./insurance-frontend
      
      - name: Upload Backend Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-report
          path: ./coverage/
      - name: Upload Frontend Coverage Report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: ./insurance-frontend/coverage/

  # --- 4. LINT Job ---
  lint:
    name: 4. Lint
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            **/package-lock.json
      - name: Install Backend Dependencies
        run: npm ci
      - name: Run Backend Lint
        run: npm run lint --if-present -- --output-file lint-report.json --format json
        working-directory: ./
        continue-on-error: true # Continue so we can upload the report
      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./insurance-frontend
      - name: Run Frontend Lint
        run: npm run lint --if-present -- --output-file lint-report.json --format json
        working-directory: ./insurance-frontend
        continue-on-error: true # Continue so we can upload the report
      - name: Upload Backend Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-lint-report
          path: ./lint-report.json
          if-no-files-found: ignore
      - name: Upload Frontend Lint Report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-lint-report
          path: ./insurance-frontend/lint-report.json
          if-no-files-found: ignore

  # --- 5. SECURITY Job ---
  security:
    name: 5. Security Audit
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            **/package-lock.json
      - name: Install Backend Dependencies
        run: npm ci
      - name: Run Backend Audit
        run: npm audit --json > npm-audit-backend.json || true
      - name: Install Frontend Dependencies
        run: npm ci
        working-directory: ./insurance-frontend
      - name: Run Frontend Audit
        run: npm audit --json > npm-audit-frontend.json || true
        working-directory: ./insurance-frontend
      - name: Upload Backend Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: backend-security-report
          path: ./npm-audit-backend.json
      - name: Upload Frontend Audit Report
        uses: actions/upload-artifact@v4
        with:
          name: frontend-security-report
          path: ./insurance-frontend/npm-audit-frontend.json

  # --- 6. DEPLOY ARTIFACT Job ---
  create-artifact:
    name: 6. Create Deployment Artifact
    runs-on: ubuntu-latest
    needs: [test, coverage, lint, security] # Runs only if all 4 previous jobs pass
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Download all the reports
      - name: Download Backend Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage-report
          path: ./reports/backend-coverage
      - name: Download Frontend Coverage Report
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-report
          path: ./reports/frontend-coverage
      - name: Download Backend Lint Report
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: backend-lint-report
          path: ./reports/lint
      - name: Download Frontend Lint Report
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: frontend-lint-report
          path: ./reports/lint
      - name: Download Backend Security Report
        uses: actions/download-artifact@v4
        with:
          name: backend-security-report
          path: ./reports/security
      - name: Download Frontend Security Report
        uses: actions/download-artifact@v4
        with:
          name: frontend-security-report
          path: ./reports/security

      # Zip all source code AND reports into one artifact
      - name: Create Deployment Artifact
        run: |
          zip -r deployment-artifact.zip . -x "*/node_modules/*" ".git*" ".DS_Store"
          
      # Upload the final zip file
      - name: Upload Deployment Artifact
        uses: actions/upload-artifact@v4
        with:
          name: deployment-artifact
          path: ./deployment-artifact.zip
